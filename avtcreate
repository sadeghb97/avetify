#!/bin/bash
set -e

REPO_URL="https://gitlab.com/sadeghb97/avetify"

CURRENT_DIR="$(pwd)"

if [[ "$CURRENT_DIR" =~ htdocs/(.*) ]]; then
    PROJECT_NAME="${BASH_REMATCH[1]}"
else
    echo "âŒ This script must be run inside a directory under 'htdocs'."
    exit 1
fi

echo "ðŸ“ Detected project name: $PROJECT_NAME"

echo "ðŸ”„ Cloning the repository..."
if git clone "$REPO_URL" ./avetify; then
    echo "âœ… Repository cloned successfully."

    echo "ðŸ“ Creating lib directory and lib.php..."
    mkdir -p lib
    cat > lib/lib.php <<EOF
<?php

define("AVETIFY_ROOT", "/$PROJECT_NAME/avetify/");
define("MAIN_PROXY", "127.0.0.1:2081");

require_once __DIR__ . "/../avetify/avetify.php";
initAvetify(AVETIFY_ROOT);
EOF

    echo "ðŸ“„ Creating avetify.php..."
    cat > avetify.php <<'EOF'
<?php
require_once "lib/lib.php";

$avtRenderer = new AvetifyRenderer();
$avtRenderer->renderPage();
EOF

    echo "ðŸ“„ Creating index.php..."
    cat > index.php <<'EOF'
<?php
header("Location: avetify.php");
EOF

    echo "ðŸ“ Creating .gitignore..."
    cat > .gitignore <<'EOF'
avetify
.avtfiles
.idea
.tmp
test.php
EOF

    echo "ðŸŽ‰ All files and folders have been set up successfully."

else
    echo "âŒ Failed to clone the repository. Aborting."
    exit 1
fi

# Installation instructions:
# 1. Save this script as ~/avtcreate and make it executable:
#    chmod +x ~/avtcreate
# 2. (Optional) Move it to ~/bin for global use:
#    mkdir -p ~/bin
#    mv ~/avtcreate ~/bin/
# 3. Add ~/bin to your PATH if it's not already:
#    echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
#    source ~/.bashrc
# 4. Now you can run it from anywhere with:
#    avtcreate
